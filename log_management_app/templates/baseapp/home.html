{% extends 'mainhome.html' %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="row align-items-center mb-2">
                <div class="col">
                    <h2 class="h5 page-title">Welcome {{user.first_name}}</h2>
                </div>
                <div class="col-auto">
                    <form class="form-inline">
                        <div class="form-group">
                            <button type="button" class="btn btn-sm"><span class="fe fe-refresh-ccw fe-16 text-muted"></span></button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="row">
                <div class="col-md-6 col-xl-3 mb-4">
                    <div class="card shadow">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col pr-0">
                                    <h5 class="mb-0">Total Logs</h5>
                                    <span class="h4 small mb-0">{{ total_logs }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-xl-3 mb-4">
                    <div class="card shadow">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col pr-0">
                                    <h5 class="mb-0">Processed Logs</h5>
                                    <span class="h4 small mb-0">{{ processed_logs }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-xl-3 mb-4">
                    <div class="card shadow">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col pr-0">
                                    <h5 class="mb-0">Alerts Triggered</h5>
                                    <span class="h4 small mb-0">{{ alerts_triggered }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-xl-3 mb-4">
                    <div class="card shadow">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col pr-0">
                                    <h5 class="mb-0">Linux Log Sources</h5>
                                    <span class="h4 small mb-0">{{ total_log_sources }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Linux Overview and Severity -->
            <div class="row items-align-baseline">
                <div class="col-md-6">
                    <div class="card shadow mb-4">
                        <div class="card-header">
                            <strong>Linux Server Overview</strong>
                        </div>
                        <div class="card-body px-4">
                            <div class="text-center mb-3">                    
                                <span class="h3">Linux Server</span><br />
                                <span class="small text-muted">{{ linux_alert_percentage }}% of total alerts</span>                    
                            </div>
                            <table class="table table-borderless mt-3 mb-1 mx-n1 table-sm">
                                <thead>
                                    <tr>
                                        <th class="w-50">Metric</th>
                                        <th class="text-right">Count</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Total Logs</td>
                                        <td class="text-right">{{ total_linux_logs }}</td>
                                    </tr>
                                    <tr>
                                        <td>Total Alerts</td>
                                        <td class="text-right">{{ linux_alerts }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow eq-card mb-4">
                        <div class="card-header">
                            <strong>Alert Severity Distribution</strong>
                        </div>
                        <div class="card-body">
                            <div class="row items-align-center">
                                <div class="col-3 text-center">
                                    <p class="text-muted mb-1">Critical</p>
                                    <h6 class="mb-1">{{ severity_counts.Critical }}</h6>                    
                                </div>
                                <div class="col-3 text-center">
                                    <p class="text-muted mb-1">High</p>
                                    <h6 class="mb-1">{{ severity_counts.High }}</h6>                    
                                </div>
                                <div class="col-3 text-center">
                                    <p class="text-muted mb-1">Low</p>
                                    <h6 class="mb-1">{{ severity_counts.Low }}</h6>                    
                                </div>
                                <div class="col-3 text-center">
                                    <p class="text-muted mb-1">Info</p>
                                    <h6 class="mb-1">{{ severity_counts.Info }}</h6>                    
                                </div>
                            </div>
                            <div class="mt-3 text-center">
                              <canvas id="severityChart" height="150"></canvas>
                          </div>
                          
                          <script>
                          document.addEventListener('DOMContentLoaded', function() {
                              const ctx = document.getElementById('severityChart').getContext('2d');
                              const chart = new Chart(ctx, {
                                  type: 'doughnut',
                                  data: {
                                      labels: ['Critical', 'High', 'Low', 'Info'],
                                      datasets: [{
                                          data: [
                                              {{ severity_counts.Critical }},
                                              {{ severity_counts.High }},
                                              {{ severity_counts.Low }},
                                              {{ severity_counts.Info }}
                                          ],
                                          backgroundColor: [
                                              '#dc3545', // Critical - red
                                              '#ffc107', // High - yellow
                                              '#17a2b8', // Low - cyan
                                              '#6c757d'  // Info - gray
                                          ],
                                          borderWidth: 0
                                      }]
                                  },
                                  options: {
                                      cutout: '70%',
                                      plugins: {
                                          legend: {
                                              display: false
                                          }
                                      }
                                  }
                              });
                          });
                          </script>
                            
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="row">
                <div class="col-md-12 col-lg-4 mb-4">
                    <div class="card timeline shadow">
                        <div class="card-header">
                            <strong class="card-title">Recent Reports</strong>
                            <a class="float-right small text-muted" href="{% url 'gen_reports' %}">View all</a>
                        </div>
                        <div class="card-body" data-simplebar style="height:355px; overflow-y: auto; overflow-x: hidden;">
                            {% for report in recent_reports %}
                                <div class="pb-3 timeline-item item-primary report-item">
                                    <div class="pl-5">
                                        <div class="mb-1">
                                            <strong>{{ report.generated_by.username }}</strong>
                                            <span class="text-muted small mx-2">generated a new report:</span>
                                            <strong>{{ report.report_title }}</strong>
                                        </div>
                                        <p class="small text-muted">
                                            {{ report.generated_at|timesince }} ago
                                            <a href="{% url 'report_detail' report.id %}" class="badge badge-primary">View Details</a>
                                        </p>
                                    </div>
                                </div>
                                {% if not forloop.last %}<hr>{% endif %}
                            {% empty %}
                                <div class="pb-3 timeline-item item-primary">
                                    <div class="pl-5">
                                        <div class="mb-1">
                                            <strong>No reports found.</strong>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Recent Alerts -->
                <div class="col-md-12 col-lg-8">
                    <div class="card shadow">
                        <div class="card-header">
                            <strong class="card-title">Recent Alerts</strong>
                            <a class="float-right small text-muted" href="{% url 'alert_history' %}">View all</a>
                        </div>
                        <div class="card-body my-n2">
                            <table class="table table-striped table-hover table-borderless">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Hostname</th>
                                        <th>Severity</th>
                                        <th>Alert Title</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for alert in total_sys_alerts %}
                                    <tr>
                                        <td>{{ alert.timestamp }}</td>
                                        <td>{{ alert.hostname }}</td>
                                        <td><span class="badge 
                                            {% if alert.severity == 'Critical' %}badge-danger
                                            {% elif alert.severity == 'High' %}badge-warning
                                            {% elif alert.severity == 'Low' %}badge-info
                                            {% else %}badge-secondary{% endif %}">
                                            {{ alert.severity }}
                                        </span></td>
                                        <td>{{ alert.alert_title }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="4" class="text-center">No alerts found</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}